<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="1" author="artem-suslov" >
       <createTable tableName="UserAccounts" schemaName="testtsu">
           <column name="userId" type="bigint" autoIncrement="true" >
               <constraints primaryKey="true"  primaryKeyName="userAccountsPrimaryKey" nullable="false"/>
           </column>
           <column name="login" type="varchar(100)">
               <constraints nullable="false"/>
           </column>
           <column name="hashedPassword" type="varchar(100)">
               <constraints nullable="false"/>
           </column>
           <column name="salt" type="varchar(100)">
               <constraints nullable="false"/>
           </column>
       </createTable>
       <createTable tableName="UserProfiles" schemaName="testtsu">
           <column name="userId" type="bigint">
               <constraints nullable="false" foreignKeyName="userProfilesForeignKey" references="UserAccounts(userId)" primaryKey="true" primaryKeyName="userProfilesPrimaryKey" deleteCascade="true"/>
           </column>
           <column name="name" type="varchar(200)">
               <constraints nullable="false"/>
           </column>
           <column name="surname" type="varchar(200)">
               <constraints nullable="false"/>
           </column>
           <column name="patronymic" type="varchar(200)">
               <constraints nullable="true"/>
           </column>
           <column name="dateOfBirth" type="date">
               <constraints nullable="false"/>
           </column>
           <column name="sex" type="char(1)">
               <constraints nullable="false"/>
           </column>
           <column name="email" type="varchar(100)">
               <constraints nullable="false"/>
           </column>
           <column name="timezone" type="varchar(150)">
               <constraints nullable="false"/>
           </column>
       </createTable>
   </changeSet>
   <changeSet id="2" author="artem-suslov" >
       <createTable tableName="UserGroups" schemaName="testtsu">
           <column name="id" type="bigint" autoIncrement="true" >
               <constraints primaryKey="true"  primaryKeyName="userGroupssPrimaryKey" nullable="false"/>
           </column>
           <column name="name" type="varchar(255)">
               <constraints nullable="false"/>
           </column>
       </createTable>
   </changeSet>
    <changeSet id="3" author="artem-suslov" >
        <createTable tableName="UserGroupsAndAccountsRelationships" schemaName="testtsu">
            <column name="userGroupId" type="bigint">
                <constraints nullable="false" foreignKeyName="userGroupsAndAccountsRelationshipsToUserGroupsForeignKey" references="UserGroups(id)" deleteCascade="true"/>
            </column>
            <column name="userAccountId" type="bigint">
                <constraints nullable="false" foreignKeyName="userGroupsAndAccountsRelationshipsToUserAccountsForeignKey" references="UserAccounts(userId)" primaryKey="true" primaryKeyName="userGroupsAndAccountsRelationshipsPrimaryKey" deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="4" author="artem-suslov">
        <createView schemaName="testtsu" viewName="Users">
            SELECT 
            UA.userId as UserAccounts_userId,UA.login as UserAccounts_login,UA.hashedPassword as UserAccounts_hashedPassword, UA.salt as UserAccounts_salt,
            UP.userId as UserProfiles_userId,UP.name as UserProfiles_name,UP.surname as UserProfiles_surname,UP.patronymic as UserProfiles_patronymic, UP.dateOfBirth as UserProfiles_dateOfBirth, UP.sex as UserProfiles_sex,UP.email as UserProfiles_email,UP.timezone as UserProfiles_timezone,
            UG.id as UserGroups_id, UG.name as UserGroups_name
            FROM UserAccounts AS UA
            INNER JOIN UserProfiles AS UP ON UP.userId=UA.userId
            INNER JOIN UserGroupsAndAccountsRelationships AS UGAAR ON UGAAR.userAccountId=UA.userId
            INNER JOIN UserGroups AS UG ON UG.id=UGAAR.userGroupId
        </createView>
    </changeSet>
    <changeSet id="insert-ststic-content" author="artem-suslov">
        
        <insert schemaName="testtsu"  tableName="UserGroups">
            <column name="id" value="1"/>
            <column name="name" value="Admin"/>
        </insert>
        
        <insert schemaName="testtsu"  tableName="UserAccounts"> <!-- A12345aqwerty -->
            <column name="userId" value="1"/>
            <column name="login" value="admin"/>
            <column name="hashedPassword" value="Sdoq58CVvBteir7hT3PX+ZWjaCg7pugCRLAeTAV2JlM="/>
            <column name="salt" value="/unhHbfn6N0F+p5MpeyZiQ=="/>
        </insert>
        <insert schemaName="testtsu"  tableName="UserProfiles">
            <column name="userId" value="1"/>
            <column name="name" value="Admin"/>
            <column name="surname" value="Admin"/>
            <column name="patronymic" value="Admin"/>
            <column name="dateOfBirth" value="1970-01-01"/>
            <column name="email" value="admin@email.com"/>
            <column name="sex" value="m"/>
            <column name="timeZone" value="UTC"/>
        </insert>
        <insert schemaName="testtsu"  tableName="UserGroupsAndAccountsRelationships">
            <column name="userGroupId" value="1"/>
            <column name="userAccountId" value="1"/>
        </insert>
    </changeSet>
    <changeSet id="createPagesTable" author="artem-suslov" >
        <createTable tableName="Pages" schemaName="testtsu" >
            <column name="id" type="bigint" autoIncrement="true">
               <constraints primaryKey="true"  primaryKeyName="pagesPrimaryKey" nullable="false"/>
            </column>
            <column name="name" type="varchar(100)">
               <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
               <constraints nullable="false"/>
            </column>
            <column name="content" type="text">
               <constraints nullable="false"/>
            </column>
            <column name="language" type="char(2)">
               <constraints primaryKey="true"  primaryKeyName="pagesPrimaryKey" nullable="false"/>
            </column>            
            <column name="creationUTCDateTime" type="datetime">
               <constraints nullable="false"/>
            </column>
            <column name="creatorId" type="bigint">
               <constraints nullable="false"/>
            </column>
            <column name="lastChangingUTCDateTime" type="datetime">
               <constraints nullable="false"/>
            </column>
            <column name="lastChangerId" type="bigint">
               <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="createUserGroupsAndUserRolesR10psTable" author="artem-suslov" >
        <createTable tableName="UserGroupsAndUserRolesRelationships" schemaName="testtsu" >
            <column name="userGroupId" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="userGroupsAndAccountsRelationshipsPrimaryKey" />
            </column>
            <column name="userRoleId" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="userGroupsAndAccountsRelationshipsPrimaryKey"/>
            </column>
        </createTable>
    </changeSet>
     <changeSet id="insertUserGroupsAndUserRolesStaticR10ps" author="artem-suslov">        
        <insert schemaName="testtsu"  tableName="UserGroupsAndUserRolesRelationships">
            <column name="userGroupId" value="1"/>
            <column name="userRoleId" value="1"/>
        </insert>
     </changeSet>
     <changeSet id="createMainPagesTable" author="artem-suslov" >
        <createTable tableName="MainPages" schemaName="testtsu" >
            <column name="id" type="bigint" autoIncrement="true">
               <constraints primaryKey="true"  primaryKeyName="pagesPrimaryKey" nullable="false"/>
            </column>
            <column name="name" type="varchar(100)">
               <constraints nullable="false"/>
            </column>
            <column name="title" type="varchar(255)">
               <constraints nullable="false"/>
            </column>
            <column name="content" type="text">
               <constraints nullable="false"/>
            </column>
            <column name="language" type="char(2)">
               <constraints primaryKey="true"  primaryKeyName="pagesPrimaryKey" nullable="false"/>
            </column>            
            <column name="creationUTCDateTime" type="datetime">
               <constraints nullable="false"/>
            </column>
            <column name="creatorId" type="bigint">
               <constraints nullable="false"/>
            </column>
            <column name="lastChangingUTCDateTime" type="datetime">
               <constraints nullable="false"/>
            </column>
            <column name="lastChangerId" type="bigint">
               <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
     <changeSet id="createMainPagesHierarchicalR10psTable" author="artem-suslov" >
        <createTable tableName="MainPagesHierarchicalR10ps" schemaName="testtsu" >
            <column name="parentId" type="bigint">
                 <constraints nullable="false" primaryKey="true" primaryKeyName="mainPagesHierarchicalR10psPrimaryKey" 
                             foreignKeyName="mainPagesHierarchicalR10psToMainPages1ForeignKey" references="MainPages(id)" 
                             deleteCascade="true"/>
            </column>
            <column name="childId" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="mainPagesHierarchicalR10psPrimaryKey" 
                             foreignKeyName="mainPagesHierarchicalR10psToMainPages2ForeignKey" references="MainPages(id)" 
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="createTotalMainPagesView" author="artem-suslov">
        <createView schemaName="testtsu"  viewName="TotalMainPages">
            SELECT 
            mpParent.id as ParentMainPages_id, mpParent.name as ParentMainPages_name, mpParent.title as ParentMainPages_title, mpParent.content as ParentMainPages_content, mpParent.language as ParentMainPages_language, mpParent.creationUTCDateTime as ParentMainPages_creationUTCDateTime, mpParent.creatorId as ParentMainPages_creatorId, mpParent.lastChangingUTCDateTime as ParentMainPages_lastChangingUTCDateTime,mpParent.lastChangerId  as ParentMainPages_lastChangerId,
            mpChild.id as ChildrenMainPages_id, mpChild.name as ChildrenMainPages_name, mpChild.title as ChildrenMainPages_title, mpChild.content as ChildrenMainPages_content, mpChild.language as ChildrenMainPages_language, mpChild.creationUTCDateTime as ChildrenMainPages_creationUTCDateTime, mpChild.creatorId as ChildrenMainPages_creatorId, mpChild.lastChangingUTCDateTime as ChildrenMainPages_lastChangingUTCDateTime,mpChild.lastChangerId  as ChildrenMainPages_lastChangerId
            FROM `MainPages` as mpChild
            INNER JOIN MainPagesHierarchicalR10ps as r10p ON childId=mpChild.id
            INNER JOIN `MainPages` as mpParent ON mpParent.id=parentId AND mpParent.language=mpChild.language
        </createView>
    </changeSet>
</databaseChangeLog>
